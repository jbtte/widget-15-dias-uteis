<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data - N Dias Ãšteis Antes</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: system-ui, sans-serif;
      color: #111;
      text-align: center;
    }
    .date {
      font-size: clamp(36px, 8vw, 64px);
      font-weight: 700;
      line-height: 1.1;
    }
    .sub {
      font-size: 1rem;
      color: #666;
    }
  </style>
</head>
<body>
  <div id="date" class="date"></div>
  <div id="sub" class="sub"></div>

<script>
(async function(){
  const tz = 'America/Sao_Paulo';
  const params = new URLSearchParams(location.search);
  const offset = Number(params.get('offset') || 15);
  const jsonUrl = params.get('json') || '';

  function fmtDate(d, opts={}) { return new Intl.DateTimeFormat('pt-BR', { timeZone: tz, ...opts }).format(d); }
  function pad(n) { return String(n).padStart(2,'0'); }
  function ymd(d) {
    const p = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' })
      .formatToParts(d).reduce((a,x)=>{a[x.type]=x.value;return a;},{});
    return `${p.year}-${p.month}-${p.day}`;
  }
  function addDays(date, days) { const d=new Date(date.getTime()); d.setUTCDate(d.getUTCDate()+days); return d; }
  function easterDate(year){ const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3);
    const h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451);
    const month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1;
    return new Date(Date.UTC(year,month-1,day,12,0,0));
  }
  function brazilHolidays(year){
    const set=new Set(), add=(y,m,d)=>set.add(`${y}-${pad(m)}-${pad(d)}`);
    add(year,1,1);add(year,4,21);add(year,5,1);add(year,9,7);add(year,10,12);add(year,11,2);add(year,11,15);add(year,12,25);
    const easter=easterDate(year);
    [-48,-47,-2,60].forEach(delta=>set.add(ymd(addDays(easter,delta))));
    return set;
  }
  function isWeekday(date){
    const w=new Intl.DateTimeFormat('en-US',{ timeZone: tz, weekday:'short'}).formatToParts(date).find(p=>p.type==='weekday').value;
    return ['Mon','Tue','Wed','Thu','Fri'].includes(w);
  }
  async function fetchJsonHolidays(url){
    try {
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) return new Set();
      const data = await res.json();
      const out = new Set();
      const pushDates = (arr)=>{ if(Array.isArray(arr)) arr.forEach(d=>{ if(typeof d==='string' && /^\\d{4}-\\d{2}-\\d{2}$/.test(d)) out.add(d); }); };
      if(Array.isArray(data)){ pushDates(data); }
      else if (data && typeof data==='object'){
        if(data.dates) pushDates(data.dates);
        if(data.holidays) pushDates(data.holidays);
        if(data.common) pushDates(data.common);
        const yearKeys = Object.keys(data).filter(k=>/^\\d{4}$/.test(k));
        yearKeys.forEach(k=>pushDates(data[k]));
      }
      return out;
    } catch { return new Set(); }
  }

  const now = new Date();
  const yearNow = Number(fmtDate(now, {year:'numeric'}));
  const holidays = new Set([
    ...brazilHolidays(yearNow-1),
    ...brazilHolidays(yearNow),
    ...brazilHolidays(yearNow+1)
  ]);

  if(jsonUrl){
    const j = await fetchJsonHolidays(jsonUrl);
    for(const d of j) holidays.add(d);
  }

  function businessDaysBack(fromDate, n){
    let d = addDays(fromDate, -1), count=0;
    while(count<n){
      if(isWeekday(d) && !holidays.has(ymd(d))){
        count++; if(count===n) return d;
      }
      d = addDays(d, -1);
    }
    return d;
  }

  const target = businessDaysBack(now, offset);
  document.getElementById('date').textContent = fmtDate(target, { day:'2-digit', month:'2-digit', year:'numeric' });
  document.getElementById('sub').textContent = fmtDate(target, { weekday:'long' });
})();
</script>
</body>
</html>
