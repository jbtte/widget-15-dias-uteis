<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data - N Dias Úteis Antes</title>
  <style>
    :root {
      --fg: #111;        /* cor do texto */
      --muted: #666;     /* cor secundária */
      --pill-bg: rgba(0,0,0,.06);
      --pill-border: rgba(0,0,0,.18);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --fg: #fff;
        --muted: #bbb;
        --pill-bg: rgba(255,255,255,.08);
        --pill-border: rgba(255,255,255,.24);
      }
    }
    html, body {
      margin: 0; padding: 0;
      background: transparent;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial;
      color: var(--fg);
      text-align: center;
    }
    .wrap { display:grid; gap:.4rem; place-items:center; }
    .pill {
      display:inline-block;
      padding:.22rem .58rem;
      border:1px solid var(--pill-border);
      border-radius:999px;
      font-size:.82rem;
      color: var(--muted);
      background: var(--pill-bg);
      user-select:none;
    }
    .date {
      font-size: clamp(36px, 8vw, 64px);
      font-weight: 700;
      line-height: 1.1;
    }
    .sub {
      font-size: 1rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="badge" class="pill"></div>
    <div id="date" class="date"></div>
    <div id="sub" class="sub"></div>
  </div>

<script>
(async function(){
  const tz = 'America/Sao_Paulo';
  const params = new URLSearchParams(location.search);
  const offset = Number(params.get('offset') || 15);
  const jsonUrl = params.get('json') || '';
  const theme = (params.get('theme') || '').toLowerCase(); // 'dark' | 'light'
  const colorParam = params.get('color');                   // ex: %23ffffff, #fff, rgb(...)

  // === Tema/cores forçadas por query ===
  if (theme === 'dark') {
    document.documentElement.style.setProperty('--fg', '#ffffff');
    document.documentElement.style.setProperty('--muted', '#bbbbbb');
    document.documentElement.style.setProperty('--pill-bg', 'rgba(255,255,255,.08)');
    document.documentElement.style.setProperty('--pill-border', 'rgba(255,255,255,.24)');
  } else if (theme === 'light') {
    document.documentElement.style.setProperty('--fg', '#111111');
    document.documentElement.style.setProperty('--muted', '#666666');
    document.documentElement.style.setProperty('--pill-bg', 'rgba(0,0,0,.06)');
    document.documentElement.style.setProperty('--pill-border', 'rgba(0,0,0,.18)');
  }
  if (colorParam) {
    // cor direta do texto
    document.documentElement.style.setProperty('--fg', colorParam);
    // ajustar contraste do badge automaticamente (leve)
    const isLight = (() => {
      const c = colorParam.replace('#','');
      if (c.startsWith('rgb')) return false;
      const hex = c.length===3 ? c.split('').map(x=>x+x).join('') : c;
      const r = parseInt(hex.substring(0,2),16);
      const g = parseInt(hex.substring(2,4),16);
      const b = parseInt(hex.substring(4,6),16);
      const luminance = (0.2126*r + 0.7152*g + 0.0722*b)/255;
      return luminance > 0.6;
    })();
    document.documentElement.style.setProperty('--muted', isLight ? '#444' : '#bbb');
    document.documentElement.style.setProperty('--pill-bg', isLight ? 'rgba(0,0,0,.06)' : 'rgba(255,255,255,.08)');
    document.documentElement.style.setProperty('--pill-border', isLight ? 'rgba(0,0,0,.18)' : 'rgba(255,255,255,.24)');
  }

  function fmtDate(d, opts={}) { return new Intl.DateTimeFormat('pt-BR', { timeZone: tz, ...opts }).format(d); }
  function pad(n) { return String(n).padStart(2,'0'); }
  function ymd(d) {
    const p = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' })
      .formatToParts(d).reduce((a,x)=>{a[x.type]=x.value;return a;},{});
    return `${p.year}-${p.month}-${p.day}`;
  }
  function addDays(date, days) { const d=new Date(date.getTime()); d.setUTCDate(d.getUTCDate()+days); return d; }
  function easterDate(year){ const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3);
    const h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451);
    const month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1;
    return new Date(Date.UTC(year,month-1,day,12,0,0));
  }
  function brazilHolidays(year){
    const set=new Set(), add=(y,m,d)=>set.add(`${y}-${pad(m)}-${pad(d)}`);
    add(year,1,1);add(year,4,21);add(year,5,1);add(year,9,7);add(year,10,12);add(year,11,2);add(year,11,15);add(year,12,25);
    const easter=easterDate(year);
    [-48,-47,-2,60].forEach(delta=>set.add(ymd(addDays(easter,delta))));
    return set;
  }
  function isWeekday(date){
    const w=new Intl.DateTimeFormat('en-US',{ timeZone: tz, weekday:'short'}).formatToParts(date).find(p=>p.type==='weekday').value;
    return ['Mon','Tue','Wed','Thu','Fri'].includes(w);
  }
  async function fetchJsonHolidays(url){
    try {
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) return new Set();
      const data = await res.json();
      const out = new Set();
      const pushDates = (arr)=>{ if(Array.isArray(arr)) arr.forEach(d=>{ if(typeof d==='string' && /^\\d{4}-\\d{2}-\\d{2}$/.test(d)) out.add(d); }); };
      if(Array.isArray(data)){ pushDates(data); }
      else if (data && typeof data==='object'){
        if(data.dates) pushDates(data.dates);
        if(data.holidays) pushDates(data.holidays);
        if(data.common) pushDates(data.common);
        const yearKeys = Object.keys(data).filter(k=>/^\\d{4}$/.test(k));
        yearKeys.forEach(k=>pushDates(data[k]));
      }
      return out;
    } catch { return new Set(); }
  }

  const now = new Date();
  const yearNow = Number(fmtDate(now, {year:'numeric'}));
  const holidays = new Set([
    ...brazilHolidays(yearNow-1),
    ...brazilHolidays(yearNow),
    ...brazilHolidays(yearNow+1)
  ]);
  if(jsonUrl){
    const j = await fetchJsonHolidays(jsonUrl);
    for(const d of j) holidays.add(d);
  }

  function businessDaysBack(fromDate, n){
    let d = addDays(fromDate, -1), count=0;
    while(count<n){
      if(isWeekday(d) && !holidays.has(ymd(d))){
        count++; if(count===n) return d;
      }
      d = addDays(d, -1);
    }
    return d;
  }

  const target = businessDaysBack(now, offset);
  document.getElementById('badge').textContent = `D-${offset} úteis`;
  document.getElementById('date').textContent  = fmtDate(target, { day:'2-digit', month:'2-digit', year:'numeric' });
  document.getElementById('sub').textContent   = fmtDate(target, { weekday:'long' });
})();
</script>
</body>
</html>
