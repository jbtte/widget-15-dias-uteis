<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resultado — 15 Dias Úteis</title>
  <style>
    :root{ --bg: #000000; --fg: #ffffff; --muted: #bbbbbb; --pill-bg:rgba(0,0,0,.06); --pill-border:rgba(0,0,0,.18); --card:rgba(0,0,0,.03); --card-border:rgba(0,0,0,.12); }
    @media (prefers-color-scheme: dark){ :root{ --fg:#fff; --muted:#bbb; --pill-bg:rgba(255,255,255,.08); --pill-border:rgba(255,255,255,.24); --card:rgba(255,255,255,.06); --card-border:rgba(255,255,255,.18);} }
    html,body{margin:0;padding:0;background-color: var(--bg) !important; color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial}
    .wrap{max-width:760px;margin:16px auto;padding:8px 12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;padding:.22rem .58rem;border:1px solid var(--pill-border);border-radius:999px;font-size:.82rem;color:var(--muted);background:var(--pill-bg);user-select:none}
    label{font-size:.9rem;color:var(--muted)}
    input[type="date"]{font:inherit;padding:.45rem .6rem;border-radius:.6rem;border:1px solid var(--pill-border);background:var(--card);color:var(--fg)}
    .main{display:grid;gap:.4rem;place-items:center;text-align:center;margin-top:10px}
    .date{font-size:clamp(36px,8vw,64px);font-weight:700;line-height:1.1}
    .sub{font-size:1rem;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <span class="pill">Data inicial</span>
        <input id="start" type="date" />
      </div>
      <div id="badge" class="pill">D+15 úteis</div>
    </div>
    <div class="main">
      <div id="date" class="date"></div>
      <div id="sub" class="sub"></div>
    </div>
  </div>
<script>
(async function(){
  const tz='America/Sao_Paulo';
  const q=new URLSearchParams(location.search);
  const jsonUrl=q.get('json')||'';
  const extraParam=(q.get('extra')||'').trim();
  const hidesub=q.get('hidesub')==='1';
  const theme=(q.get('theme')||'').toLowerCase();
  const colorParam=q.get('color');
  const includeStart=q.get('includeStart')==='1';
  const FIXED_DAYS=15; // fixo em 15 dias úteis

  // Tema/cor forçada
  if(theme==='dark'){
    document.documentElement.style.setProperty('--bg', '#000000');
    document.documentElement.style.setProperty('--fg','#ffffff');
    document.documentElement.style.setProperty('--muted','#bbbbbb');
    document.documentElement.style.setProperty('--pill-bg','rgba(255,255,255,.08)');
    document.documentElement.style.setProperty('--pill-border','rgba(255,255,255,.24)');
    document.documentElement.style.setProperty('--card','rgba(255,255,255,.06)');
    document.documentElement.style.setProperty('--card-border','rgba(255,255,255,.18)');
  } else if(theme==='light'){
    document.documentElement.style.setProperty('--fg','#111111');
    document.documentElement.style.setProperty('--muted','#666666');
    document.documentElement.style.setProperty('--pill-bg','rgba(0,0,0,.06)');
    document.documentElement.style.setProperty('--pill-border','rgba(0,0,0,.18)');
    document.documentElement.style.setProperty('--card','rgba(0,0,0,.03)');
    document.documentElement.style.setProperty('--card-border','rgba(0,0,0,.12)');
  }
  if(colorParam){
    document.documentElement.style.setProperty('--fg', colorParam);
    const c=(''+colorParam).replace('#','');
    if(!c.startsWith('rgb')){
      const hex=c.length===3?c.split('').map(x=>x+x).join(''):c;
      const r=parseInt(hex.substring(0,2),16), g=parseInt(hex.substring(2,4),16), b=parseInt(hex.substring(4,6),16);
      const lum=(0.2126*r+0.7152*g+0.0722*b)/255; const light=lum>0.6;
      document.documentElement.style.setProperty('--muted', light?'#444':'#bbb');
      document.documentElement.style.setProperty('--pill-bg', light?'rgba(0,0,0,.06)':'rgba(255,255,255,.08)');
      document.documentElement.style.setProperty('--pill-border', light?'rgba(0,0,0,.18)':'rgba(255,255,255,.24)');
      document.documentElement.style.setProperty('--card', light?'rgba(0,0,0,.03)':'rgba(255,255,255,.06)');
      document.documentElement.style.setProperty('--card-border', light?'rgba(0,0,0,.12)':'rgba(255,255,255,.18)');
    }
  }

  // Utils
  const fmt=(d,opts={})=> new Intl.DateTimeFormat('pt-BR',{timeZone:tz,...opts}).format(d);
  const pad=n=> String(n).padStart(2,'0');
  const ymd=d=>{const p=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d).reduce((a,x)=>{a[x.type]=x.value;return a;},{}); return `${p.year}-${p.month}-${p.day}`;};
  const parseYMD=s=>{const [Y,M,D]=s.split('-').map(Number); return new Date(Date.UTC(Y,M-1,D,12,0,0));};
  const addDays=(d,n)=>{const x=new Date(d.getTime()); x.setUTCDate(x.getUTCDate()+n); return x;};
  function easterDate(year){ const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3); const h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451); const month=Math.floor((h+l-7*m+114)/31),day=((h+l-7*m+114)%31)+1; return new Date(Date.UTC(year,month-1,day,12,0,0)); }
  function brHolidays(y){ const s=new Set(), add=(Y,M,D)=>s.add(`${Y}-${pad(M)}-${pad(D)}`); add(y,1,1);add(y,4,21);add(y,5,1);add(y,9,7);add(y,10,12);add(y,11,2);add(y,11,15);add(y,12,25); const e=easterDate(y); [-48,-47,-2,60].forEach(d=>s.add(ymd(addDays(e,d)))); return s; }
  function isWeekday(d){ const w=new Intl.DateTimeFormat('en-US',{timeZone:tz,weekday:'short'}).formatToParts(d).find(p=>p.type==='weekday').value; return ['Mon','Tue','Wed','Thu','Fri'].includes(w); }
  function parseExtra(extra){ const s=new Set(); if(!extra) return s; extra.split(',').map(x=>x.trim()).filter(Boolean).forEach(x=>{ if(/^\d{4}-\d{2}-\d{2}$/.test(x)) s.add(x); }); return s; }
  async function fetchJson(url){ try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) return new Set(); const data=await r.json(); const out=new Set(); const push=a=>Array.isArray(a)&&a.forEach(d=>{ if(typeof d==='string' && /^\d{4}-\d{2}-\d{2}$/.test(d)) out.add(d); }); if(Array.isArray(data)) push(data); else if(data && typeof data==='object'){ if(data.dates) push(data.dates); if(data.holidays) push(data.holidays); if(data.common) push(data.common); Object.keys(data).filter(k=>/^\d{4}$/.test(k)).forEach(k=>push(data[k])); } return out; }catch{return new Set();} }

  // Holidays
  const now=new Date(); const yearNow=Number(fmt(now,{year:'numeric'}));
  const holidays=new Set();
  [yearNow-1,yearNow,yearNow+1].forEach(y=> brHolidays(y).forEach(d=>holidays.add(d)));
  parseExtra(extraParam).forEach(d=>holidays.add(d));
  if(jsonUrl){ const j=await fetchJson(jsonUrl); j.forEach(d=>holidays.add(d)); }

  // Core
  function isBiz(d){ return isWeekday(d) && !holidays.has(ymd(d)); }
  function addBiz(from,n,includeStart){ let d=new Date(from.getTime()); let count=(includeStart && isBiz(d))?1:0; if(count===n) return d; if(!includeStart) d=addDays(d,1); while(count<n){ if(isBiz(d)){ count++; if(count===n) return d; } d=addDays(d,1);} return d; }

  const startInput=document.getElementById('start');
  const badge=document.getElementById('badge');
  const dateEl=document.getElementById('date');
  const subEl=document.getElementById('sub');
  badge.textContent=`D+${FIXED_DAYS} úteis`;

  const startParam=q.get('start');
  const base = (startParam && /^\d{4}-\d{2}-\d{2}$/.test(startParam)) ? parseYMD(startParam) : now;
  startInput.value = ymd(base);

  function recalc(){
    const s = startInput.value;
    if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return;
    const base = parseYMD(s);
    const target = addBiz(base, FIXED_DAYS, includeStart);
    dateEl.textContent = fmt(target,{day:'2-digit',month:'2-digit',year:'numeric'});
    if(hidesub){ subEl.textContent=''; subEl.style.display='none'; }
    else { subEl.textContent = `Base: ${fmt(base,{day:'2-digit',month:'2-digit',year:'numeric'})} • ${fmt(target,{weekday:'long'})} • ${ymd(target)}`; subEl.style.display='block'; }
  }

  startInput.addEventListener('change', recalc);
  recalc();
})();
</script>
</body>
</html>
